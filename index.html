<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticker in Local Currency</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 1000px; margin: 30px auto; padding: 0 20px; color: #333; }
    h1 { margin-bottom: 10px; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; align-items: center; }
    input, button { padding: 8px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
    button { cursor: pointer; background-color: #f0f0f0; transition: background 0.2s; }
    button:hover { background-color: #e0e0e0; }
    button.active { background-color: #007bff; color: white; border-color: #0066cc; }
    
    .ranges { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 5px; }
    
    #status-area { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #ccc; font-size: 0.95em; }
    #status-area.error { border-left-color: #dc3545; background: #fff5f5; color: #dc3545; }
    #status-area.success { border-left-color: #28a745; background: #f0fff4; }
    #status-area.loading { border-left-color: #007bff; }
    
    /* Stats Bar */
    .stats-bar { display: flex; gap: 20px; background: #f1f8ff; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.9em; border: 1px solid #d0e3f7; }
    .stat-item strong { display: block; font-size: 0.8em; color: #666; text-transform: uppercase; }
    .stat-value { font-weight: bold; font-size: 1.1em; }
    .pos { color: #28a745; }
    .neg { color: #dc3545; }

    #measure-instruction { font-size: 0.85em; color: #666; margin-bottom: 5px; font-style: italic; }
    #chart { margin-top: 0px; min-height: 450px; }
    
    .table-container { margin-top: 30px; display: none; }
    #dataTable { width: 100%; border-collapse: collapse; font-size: 0.9em; }
    #dataTable th, #dataTable td { border: 1px solid #ddd; padding: 8px; text-align: right; }
    #dataTable th { background-color: #f2f2f2; text-align: right; position: sticky; top: 0; }
    #dataTable tr:nth-child(even) { background-color: #f9f9f9; }
    .scroll-box { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; }

    .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: #007bff; animation: spin 1s ease-in-out infinite; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<h1>Ticker in Local Currency</h1>

<div id="stock-info" style="display:none; margin-bottom: 15px; padding: 10px; background: #e8f4f8; border-radius: 5px; border-left: 4px solid #007bff;">
    <div style="font-weight: bold; font-size: 1.1em;" id="info-name">-</div>
    <div style="font-size: 0.9em; color: #555; margin-top: 5px;">
        <span id="info-symbol">-</span> | 
        <span>Base Currency: <strong id="info-currency">-</strong></span>
    </div>
</div>

<div class="controls">
  <input id="ticker" placeholder="Ticker (e.g. AAPL)">
  <span>IN</span>
  <input id="targetCurrency" placeholder="Currency (e.g. USD)" style="width:120px;">
  <button onclick="runApp()" id="btn-run">Convert & Plot</button>
  <button onclick="toggleTable()">View Data Table</button>
  <button onclick="toggleDualAxis()" id="btn-dual">Show Dual Currency</button>
</div>

<div class="ranges">
  <button onclick="setRange('MAX')" class="range-btn" data-range="MAX">Max</button>
  <button onclick="setRange('5Y')" class="range-btn" data-range="5Y">5Y</button>
  <button onclick="setRange('1Y')" class="range-btn" data-range="1Y">1Y</button>
  <button onclick="setRange('YTD')" class="range-btn" data-range="YTD">YTD</button>
  <button onclick="setRange('6M')" class="range-btn" data-range="6M">6M</button>
  <button onclick="setRange('3M')" class="range-btn" data-range="3M">3M</button>
</div>

<div id="status-area" style="display:none;"></div>

<div class="stats-bar" id="statsBar" style="display:none;">
    <div class="stat-item">
        <strong>Period Start</strong>
        <div class="stat-value" id="stat-start">-</div>
    </div>
    <div class="stat-item">
        <strong>Period End</strong>
        <div class="stat-value" id="stat-end">-</div>
    </div>
    <div class="stat-item">
        <strong id="stat-change-label">Period Gain/Loss</strong>
        <div class="stat-value" id="stat-change">-</div>
    </div>
    <div class="stat-item" id="stat-original-container" style="display:none;">
        <strong id="stat-original-label">Original Currency</strong>
        <div class="stat-value" id="stat-change-original">-</div>
    </div>
</div>

<div id="measure-instruction">ðŸ’¡ Click and drag on the chart to measure gain between any two specific points.</div>
<div id="chart"></div>

<div class="table-container" id="tableContainer">
    <h3>Data (Last 30 Days)</h3>
    <div class="scroll-box">
        <table id="dataTable">
            <thead>
                <tr><th>Date</th><th>Stock Price</th><th>FX Rate</th><th>Converted Price</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
// --- Configuration ---
const PROXY_URL = 'https://corsproxy.io/?'; 
const YAHOO_BASE = 'https://query1.finance.yahoo.com/v8/finance/chart/';

// --- State ---
let globalData = [];
let stockMeta = { symbol: '', currency: '', shortName: '', longName: '' };
let targetCurrency = '';
let showDualAxis = false;
let currentFilteredData = [];

// --- Helpers ---
const log = (msg, type = 'normal') => {
    const el = document.getElementById('status-area');
    el.style.display = 'block';
    el.className = type;
    
    let icon = '';
    if(type === 'loading') icon = '<div class="spinner"></div>';
    if(type === 'error') icon = 'âŒ ';
    if(type === 'success') icon = 'âœ… ';
    
    el.innerHTML = icon + msg;
};

// --- Core Data Fetching ---

async function fetchYahooSeries(symbol) {
    const url = `${YAHOO_BASE}${symbol}?range=10y&interval=1d`;
    const encodedUrl = PROXY_URL + encodeURIComponent(url);

    try {
        const response = await fetch(encodedUrl);
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        const json = await response.json();
        
        const result = json.chart?.result?.[0];
        if (!result) throw new Error(`No data found for ${symbol}`);

        const timestamps = result.timestamp || [];
        const quote = result.indicators?.quote?.[0] || {};
        const adjClose = result.indicators?.adjclose?.[0]?.adjclose || [];
        const close = quote.close || [];
        
        const priceArray = adjClose.length > 0 ? adjClose : close;
        const currency = result.meta?.currency || 'USD';
        const shortName = result.meta?.shortName || symbol;
        const longName = result.meta?.longName || result.meta?.shortName || symbol;

        const timeSeries = {};
        const sortedDates = [];

        timestamps.forEach((ts, i) => {
            if (priceArray[i] != null) {
                const date = new Date(ts * 1000).toISOString().split('T')[0];
                timeSeries[date] = priceArray[i];
                sortedDates.push(date);
            }
        });

        return { 
            symbol: result.meta?.symbol, 
            currency: currency,
            shortName: shortName,
            longName: longName,
            data: timeSeries,
            dates: sortedDates
        };

    } catch (e) {
        console.error("Fetch Error:", e);
        throw e;
    }
}

// --- Main Application Logic ---

async function runApp() {
    const tickerInput = document.getElementById('ticker').value.trim().toUpperCase();
    const currencyInput = document.getElementById('targetCurrency').value.trim().toUpperCase();
    targetCurrency = currencyInput;

    if (!tickerInput || !currencyInput) {
        log("Please enter both a ticker and a target currency.", "error");
        return;
    }

    log(`Fetching data for <b>${tickerInput}</b>...`, "loading");
    document.getElementById('chart').innerHTML = '';
    document.getElementById('statsBar').style.display = 'none';
    
    try {
        // 1. Fetch Stock Data
        const stockResult = await fetchYahooSeries(tickerInput);
        stockMeta = { 
            symbol: stockResult.symbol, 
            currency: stockResult.currency,
            shortName: stockResult.shortName,
            longName: stockResult.longName
        };
        
        // Update stock info display
        document.getElementById('info-name').textContent = stockResult.longName;
        document.getElementById('info-symbol').textContent = stockResult.symbol;
        document.getElementById('info-currency').textContent = stockResult.currency;
        document.getElementById('stock-info').style.display = 'block';
        
        log(`Found <b>${stockResult.symbol}</b> in <b>${stockResult.currency}</b>. fetching FX rates...`, "loading");

        let fxData = {};
        let inverted = false;

        // 2. Determine and Fetch FX Data
        if (stockResult.currency === targetCurrency) {
            fxData = null; 
        } else {
            // Strategy A: Try Direct Pair
            const pair1 = `${stockResult.currency}${targetCurrency}=X`;
            try {
                const fxResult = await fetchYahooSeries(pair1);
                fxData = fxResult.data;
            } catch (e) {
                // Strategy B: Try Inverse Pair
                const pair2 = `${targetCurrency}${stockResult.currency}=X`;
                try {
                    const fxResultInv = await fetchYahooSeries(pair2);
                    fxData = fxResultInv.data;
                    inverted = true;
                } catch (e2) {
                    throw new Error(`Could not find exchange rate for ${stockResult.currency} to ${targetCurrency}`);
                }
            }
        }

        // 3. Merge and Align Data
        globalData = alignAndConvert(stockResult, fxData, inverted);

        log(`Successfully converted ${stockMeta.symbol} to ${targetCurrency}.`, "success");
        
        // 4. Update Table and Chart
        populateTable(globalData);
        setRange('MAX'); 

    } catch (err) {
        log(err.message, "error");
    }
}

function alignAndConvert(stockRes, fxMap, isInverted) {
    const aligned = [];
    let lastKnownFx = null;

    stockRes.dates.forEach(date => {
        const stockPrice = stockRes.data[date];
        let fxRate = 1;

        if (fxMap) {
            let rawFx = fxMap[date];
            // Fill Forward FX
            if (rawFx == null && lastKnownFx !== null) {
                rawFx = lastKnownFx;
            }
            if (rawFx != null) {
                lastKnownFx = rawFx;
                fxRate = isInverted ? (1 / rawFx) : rawFx;
            } else {
                return; // Skip if no FX rate (start of data hole)
            }
        }

        aligned.push({
            date: date,
            original: stockPrice,
            fx: fxRate,
            converted: stockPrice * fxRate
        });
    });

    return aligned;
}

// --- Visualization ---

function setRange(range) {
    // 1. Update Buttons
    document.querySelectorAll('.range-btn').forEach(b => {
        b.classList.remove('active');
        if (b.getAttribute('data-range') === range) {
            b.classList.add('active');
        }
    });

    if (!globalData.length) return;

    // 2. Filter Data
    let cutoff = new Date('1900-01-01');
    const now = new Date();

    if (range === '5Y') cutoff.setFullYear(now.getFullYear() - 5);
    else if (range === '1Y') cutoff.setFullYear(now.getFullYear() - 1);
    else if (range === '6M') {
        cutoff = new Date(now);
        cutoff.setMonth(now.getMonth() - 6);
    }
    else if (range === '3M') {
        cutoff = new Date(now);
        cutoff.setMonth(now.getMonth() - 3);
    }
    else if (range === 'YTD') cutoff = new Date(now.getFullYear(), 0, 1);

    const filtered = globalData.filter(d => new Date(d.date) >= cutoff);
    
    // Store for use in event handlers
    currentFilteredData = filtered;
    
    // 3. Plot
    plotChart(filtered);
    
    // 4. Update Stats for the View immediately
    updateStats(filtered[0], filtered[filtered.length - 1]);
}

function updateStats(startPoint, endPoint) {
    if (!startPoint || !endPoint) return;
    
    const startVal = startPoint.converted;
    const endVal = endPoint.converted;
    const diff = endVal - startVal;
    const pct = (diff / startVal) * 100;
    
    const elStart = document.getElementById('stat-start');
    const elEnd = document.getElementById('stat-end');
    const elChange = document.getElementById('stat-change');
    const elChangeLabel = document.getElementById('stat-change-label');
    
    elStart.innerText = `${startPoint.date}: ${startVal.toFixed(2)}`;
    elEnd.innerText = `${endPoint.date}: ${endVal.toFixed(2)}`;
    
    const colorClass = diff >= 0 ? 'pos' : 'neg';
    const sign = diff >= 0 ? '+' : '';
    
    elChangeLabel.textContent = `${targetCurrency} Gain/Loss`;
    elChange.innerHTML = `<span class="${colorClass}">${sign}${diff.toFixed(2)} (${sign}${pct.toFixed(2)}%)</span>`;
    
    // Show original currency stats if in dual mode
    const elOriginalContainer = document.getElementById('stat-original-container');
    if (showDualAxis && stockMeta.currency !== targetCurrency) {
        const startOriginal = startPoint.original;
        const endOriginal = endPoint.original;
        const diffOriginal = endOriginal - startOriginal;
        const pctOriginal = (diffOriginal / startOriginal) * 100;
        
        const colorClassOriginal = diffOriginal >= 0 ? 'pos' : 'neg';
        const signOriginal = diffOriginal >= 0 ? '+' : '';
        
        document.getElementById('stat-original-label').textContent = `${stockMeta.currency} Gain/Loss`;
        document.getElementById('stat-change-original').innerHTML = 
            `<span class="${colorClassOriginal}">${signOriginal}${diffOriginal.toFixed(2)} (${signOriginal}${pctOriginal.toFixed(2)}%)</span>`;
        
        elOriginalContainer.style.display = 'block';
    } else {
        elOriginalContainer.style.display = 'none';
    }
    
    document.getElementById('statsBar').style.display = 'flex';
}

function plotChart(data) {
    const x = data.map(d => d.date);
    const yConverted = data.map(d => d.converted);
    const yOriginal = data.map(d => d.original);

    const traces = [{
        x: x,
        y: yConverted,
        mode: 'lines',
        line: { color: '#007bff', width: 2 },
        name: `${stockMeta.symbol} (${targetCurrency})`,
        yaxis: 'y1'
    }];

    // Add second trace if dual axis is enabled
    if (showDualAxis && stockMeta.currency !== targetCurrency) {
        traces.push({
            x: x,
            y: yOriginal,
            mode: 'lines',
            line: { color: '#28a745', width: 2, dash: 'dot' },
            name: `${stockMeta.symbol} (${stockMeta.currency})`,
            yaxis: 'y2'
        });
    }

    const layout = {
        title: { text: `${stockMeta.symbol} Price in ${targetCurrency}`, x: 0.05 },
        margin: { t: 40, r: showDualAxis ? 60 : 20, l: 50, b: 40 },
        xaxis: { showgrid: false },
        yaxis: { 
            title: targetCurrency, 
            showgrid: true, 
            gridcolor: '#eee',
            side: 'left'
        },
        dragmode: 'select',
        hovermode: 'closest',
        selectdirection: 'h'
    };

    // Add second y-axis if dual currency mode
    if (showDualAxis && stockMeta.currency !== targetCurrency) {
        layout.yaxis2 = {
            title: stockMeta.currency,
            overlaying: 'y',
            side: 'right',
            showgrid: false
        };
    }

    const config = { responsive: true, displayModeBar: true, displaylogo: false };

    Plotly.newPlot('chart', traces, layout, config);

    const chartDiv = document.getElementById('chart');

    // Listener for Selection (Click and Drag) - with snap to nearest date
    chartDiv.on('plotly_selected', (eventData) => {
        if (!eventData || !eventData.range) return;
        
        const xRange = eventData.range.x;
        if (!xRange || xRange.length !== 2) return;
        
        // Find nearest data points by snapping to closest dates
        const startDate = new Date(xRange[0]);
        const endDate = new Date(xRange[1]);
        
        // Find the closest actual data point to start
        let startPoint = data[0];
        let minStartDiff = Math.abs(new Date(data[0].date) - startDate);
        
        for (let i = 1; i < data.length; i++) {
            const diff = Math.abs(new Date(data[i].date) - startDate);
            if (diff < minStartDiff) {
                minStartDiff = diff;
                startPoint = data[i];
            } else {
                break; // Data is sorted, so we can stop
            }
        }
        
        // Find the closest actual data point to end
        let endPoint = data[data.length - 1];
        let minEndDiff = Math.abs(new Date(data[data.length - 1].date) - endDate);
        
        for (let i = data.length - 2; i >= 0; i--) {
            const diff = Math.abs(new Date(data[i].date) - endDate);
            if (diff < minEndDiff) {
                minEndDiff = diff;
                endPoint = data[i];
            } else {
                break;
            }
        }
        
        updateStats(startPoint, endPoint);
        
        // Add visual markers at the snapped positions
        const shapes = [
            {
                type: 'line',
                x0: startPoint.date,
                x1: startPoint.date,
                y0: 0,
                y1: 1,
                yref: 'paper',
                line: { color: '#ff6b6b', width: 2, dash: 'dash' }
            },
            {
                type: 'line',
                x0: endPoint.date,
                x1: endPoint.date,
                y0: 0,
                y1: 1,
                yref: 'paper',
                line: { color: '#ff6b6b', width: 2, dash: 'dash' }
            }
        ];
        
        Plotly.relayout(chartDiv, { shapes: shapes });
    });
    
    // Listener for Double Click (Reset)
    chartDiv.on('plotly_doubleclick', () => {
       updateStats(data[0], data[data.length-1]);
       // Clear the visual markers
       Plotly.relayout(chartDiv, { shapes: [] });
    });
}

// --- Table Logic ---
function populateTable(data) {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    const recent = data.slice(-30).reverse();
    
    recent.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.date}</td>
            <td>${row.original.toFixed(2)} ${stockMeta.currency}</td>
            <td>${row.fx.toFixed(4)}</td>
            <td><b>${row.converted.toFixed(2)} ${targetCurrency}</b></td>
        `;
        tbody.appendChild(tr);
    });
}

function toggleTable() {
    const el = document.getElementById('tableContainer');
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
}

function toggleDualAxis() {
    if (!globalData.length) return;
    
    showDualAxis = !showDualAxis;
    const btn = document.getElementById('btn-dual');
    
    if (showDualAxis) {
        btn.classList.add('active');
        btn.textContent = 'Hide Dual Currency';
    } else {
        btn.classList.remove('active');
        btn.textContent = 'Show Dual Currency';
    }
    
    // Redraw chart with current filtered data
    if (currentFilteredData.length > 0) {
        plotChart(currentFilteredData);
    }
}

document.querySelectorAll('input').forEach(item => {
    item.addEventListener('keypress', event => {
        if (event.key === "Enter") runApp();
    })
});

window.onload = runApp;

</script>
</body>
</html>